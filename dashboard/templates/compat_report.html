<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8">
  <title>API suderinamumo testas</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    body { 
        font-family: system-ui, sans-serif; 
        color: #e5e7eb; 
        background: #0d1117; 
        margin: 0; 
        padding: 20px; 
    }
    h1 { 
        font-size: 1.6rem; 
        margin-bottom: 10px; 
        color: #f9fafb; 
    }
    /* Naujas stilius konteineriui, kad mygtukai bÅ«tÅ³ vienoje eilutÄ—je */
    .controls-container { 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        margin-top: 15px; 
    }
    
    /* =================================================================== */
    /* CSS PATAISOS */
    /* =================================================================== */

    /* Padidinta specifiÅ¡kumas ir table-layout: fixed (bÅ«tina, kad veiktÅ³ plotis) */
    .results table { 
        width: 95%; 
        border-collapse: collapse; 
        margin-top: 20px; 
        table-layout: fixed; 
    }
    
    .results th, .results td { 
        padding: 10px; 
        border-bottom: 1px solid rgba(255,255,255,0.1); 
        text-align: left;
        word-wrap: break-word; 
    }
    .results th { 
        background: #161b22; 
        color: #f1f5f9; 
    }

    /* StulpeliÅ³ ploÄiai */
    .results thead tr th:nth-child(1),
    .results tbody tr td:nth-child(1) {
        width: 35%; /* Endpoint */
    }
    .results thead tr th:nth-child(2),
    .results tbody tr td:nth-child(2) {
        width: 15%; /* Statusas */
        text-align: center; 
    }
    .results thead tr th:nth-child(3),
    .results tbody tr td:nth-child(3) {
        width: 50%; /* TrÅ«kstami laukai */
    }

    /* BÅ«senos ir trÅ«kstamÅ³ laukÅ³ stiliai */
    tr.ok td.status { 
        color: #22c55e; 
        font-weight: 600; 
        text-align: center;
    }
    tr.fail td.status { 
        color: #ef4444; 
        font-weight: 600; 
        text-align: center;
    }
    
    .missing { /* Atitinka JS naudojamÄ… klasÄ™ */
        color: #facc15; 
        font-style: italic; 
    }
    
    /* Kiti stiliai (nepakitÄ™) */
    #btn-toggle-sound {
        border: none; padding: 10px 15px; background-color: #374151; color: #f3f4f6; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; margin-left: 15px; font-weight: 500; display: flex; align-items: center;
    }
    #btn-toggle-sound:hover { background-color: #4b5563; }
    #btn-toggle-sound.enabled { background-color: #22c55e; color: #0d1117; }
    #btn-toggle-sound.enabled:hover { background-color: #16a34a; }
    #btn-refresh {
        border: none; padding: 10px 15px; background-color: #3b82f6; color: #f3f4f6; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; margin-left: 15px; font-weight: 500; min-width: 100px;
    }
    #btn-refresh:hover:not(:disabled) { background-color: #2563eb; }
    #btn-refresh:disabled { background-color: #4b5563; cursor: not-allowed; }
</style>
</head>
<body>
  <div class="controls-container">
    <div class="summary">
      <p id="summary-text" class="summary-text">Rezultatai bus rodomi Äia...</p>
    </div>
    <div style="display: flex; align-items: center;">
      <button id="btn-refresh" class="refresh">Atnaujinti</button>
      <button id="btn-toggle-sound" title="Ä®jungti/iÅ¡jungti garso signalÄ…">
        <span id="sound-icon">ğŸ”ˆ</span>
      </button>
    </div>
  </div>

  <div class="results">
    <table>
      <thead>
        <tr>
          <th>Endpoint</th>
          <th>Statusas</th>
          <th>TrÅ«kstami laukai</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
Â  // =================================================================
Â  // GARSO KONTROLÄ–S KINTAMASIS (Numatyta: Ä®jungtas)
Â  // =================================================================
Â  let isSoundEnabled = (localStorage.getItem('soundEnabled') !== 'false'); 
Â  
Â  // =================================================================
Â  // NAUJA FUNKCIJA: Garso paleidimas naudojant Audio objektÄ…
Â  // =================================================================
Â  const alertSound = new Audio('{{ url_for("static", filename="sound/off-hook.mp3") }}');
Â  alertSound.loop = false; 

Â  function playBeep() {
Â  Â  if (!isSoundEnabled) { return; }
Â  Â  
Â  Â  try {
Â  Â  Â  Â  alertSound.currentTime = 0;
Â  Â  Â  Â  alertSound.play().catch(e => {
Â  Â  Â  Â  Â  Â  console.warn("Garso paleidimo klaida. Gali reikÄ—ti vartotojo sÄ…veikos:", e.message);
Â  Â  Â  Â  });
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Klaida paleidÅ¾iant garsÄ…:", e);
Â  Â  }
Â  }

Â  // =================================================================
Â  // Funkcija garso mygtuko bÅ«senos atnaujinimui
Â  // =================================================================
Â  function updateSoundButton() {
Â  Â  Â  const btn = document.getElementById('btn-toggle-sound');
Â  Â  Â  const icon = document.getElementById('sound-icon');
Â  Â  Â  if (isSoundEnabled) {
Â  Â  Â  Â  Â  icon.textContent = 'ğŸ”ˆ'; 
Â  Â  Â  Â  Â  btn.classList.remove('disabled');
Â  Â  Â  Â  Â  btn.title = 'Garso signalas Ä¯jungtas. Paspauskite, kad iÅ¡jungtumÄ—te.';
Â  Â  Â  } else {
Â  Â  Â  Â  Â  icon.textContent = 'ğŸ”‡'; 
Â  Â  Â  Â  Â  btn.classList.add('disabled');
Â  Â  Â  Â  Â  btn.title = 'Garso signalas iÅ¡jungtas. Paspauskite, kad Ä¯jungtumÄ—te.';
Â  Â  Â  }
Â  }

Â  // =================================================================
Â  // PagrindinÄ— tikrinimo funkcija
Â  // =================================================================
Â  async function runCheck() {
Â  Â  const btn = document.getElementById('btn-refresh');
Â  Â  btn.disabled = true;
Â  Â  btn.textContent = "Tikrinama...";
Â  Â  const tbody = document.querySelector('.results tbody');
Â  Â  tbody.innerHTML = "";
Â  Â  try {
Â  Â  Â  const res = await fetch('/api/check_compat_matrix');
Â  Â  Â  const data = await res.json();

Â  Â  Â  data.details.forEach(item => {
Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  tr.className = item.status === "ok" ? "ok" : "fail";
Â  Â  Â  Â  const missing = (item.missing_fields && item.missing_fields.length)
Â  Â  Â  Â  Â  ? item.missing_fields.join(", ")
Â  Â  Â  Â  Â  : "";

        // ğŸ’¡ KRITINÄ– PATAISA: Ä®terpiame HTML turinÄ¯ vienoje eilutÄ—je
Â  Â  Â  Â  tr.innerHTML = `<td>${item.endpoint}</td><td class="status">${item.status.toUpperCase()}</td><td>${missing ? `<div class="missing">${missing}</div>` : ""}</td>`;
Â  Â  Â  Â  
        tbody.appendChild(tr);
Â  Â  Â  });

Â  Â  Â  const s = data.summary;
Â  Â  Â  document.getElementById('summary-text').textContent =
Â  Â  Â  Â  `IÅ¡ viso: ${s.total}, âœ… OK: ${s.passed}, âŒ FAIL: ${s.failed}`;

Â  Â  Â  // Garsas, jei bent vienas statusas yra FAIL
Â  Â  Â  if (s.failed > 0) {
Â  Â  Â  Â  Â  playBeep();
Â  Â  Â  }

Â  Â  } catch (err) {
Â  Â  Â  alert("Klaida gaunant duomenis iÅ¡ /api/check_compat_matrix");
Â  Â  Â  console.error(err);
Â  Â  } finally {
Â  Â  Â  btn.textContent = "Atnaujinti";
Â  Â  Â  btn.disabled = false;
Â  Â  }
Â  }

Â  // =================================================================
Â  // Ä®VYKIÅ² KLAUSYTOJAI (Event Listeners)
Â  // =================================================================
Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  // Garso mygtuko perjungimo logika
Â  Â  const soundBtn = document.getElementById('btn-toggle-sound');
Â  Â  soundBtn.addEventListener('click', () => {
Â  Â  Â  Â  isSoundEnabled = !isSoundEnabled; 
Â  Â  Â  Â  localStorage.setItem('soundEnabled', isSoundEnabled); 
Â  Â  Â  Â  updateSoundButton(); 
Â  Â  Â  Â  if (isSoundEnabled) {
Â  Â  Â  Â  Â  Â  playBeep(); 
Â  Â  Â  Â  }
Â  Â  });
Â  Â  
Â  Â  updateSoundButton(); 
Â  Â  
Â  Â  // Pradinis patikrinimas ir automatinis atnaujinimas
Â  Â  runCheck(); 
Â  Â  setInterval(runCheck, 5000); 
Â  Â  
Â  Â  // Atnaujinimo mygtukas
Â  Â  document.getElementById('btn-refresh').addEventListener('click', runCheck);
Â  });
Â  </script>
</body>
</html>